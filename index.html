<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Forum Tanya Jawab</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <div class="donasi-container">
    <h2>Dukung dengan Donasi</h2>
    <div class="donasi-box">
      <a href="https://saweria.co/FaziCihuy" target="_blank" class="btn-saweria">ðŸš€ Donasi via Saweria</a>
      <img class="qr" src="qr.png" alt="QR Saweria"/>
    </div>
  </div>

  <div class="container">
    <header>
      <h1>Forum Tanya Jawab</h1>
      <p style="margin:0;color:var(--muted)">Kirim pesan â€” akan tampil <strong>setelah</strong> disetujui admin.</p>
    </header>

    <main>
      <section class="card" id="publicPage">
        <form id="frm">
          <input id="nama" type="text" placeholder="Nama (opsional)" />
          <textarea id="pesan" placeholder="Tulis pesan..."></textarea>
          <div class="row">
            <button type="button" class="btn" id="btnKirim">Kirim</button>
            <button type="button" class="btn ghost" id="btnClear">Bersihkan</button>
            <a href="#admin" class="admin-link">Masuk ke halaman admin</a>
          </div>
        </form>

        <div id="notice" style="margin-top:12px;color:var(--muted);font-size:13px"></div>
        <div id="listPesan"></div>
      </section>

      <section class="card" id="adminPage" aria-hidden="true">
        <h2>Admin Panel</h2>
        <div id="adminWrap">
          <div id="loginBox">
            <p>Masuk sebagai admin (email & password)</p>
            <input id="adminEmail" type="email" placeholder="Email admin" />
            <input id="adminPass" type="password" placeholder="Password admin" />
            <div style="margin-top:8px">
              <button id="btnLogin" class="btn">Login</button>
              <a href="#" id="backPublic" class="admin-link">Kembali</a>
            </div>
            <div id="loginMsg" style="color:var(--danger);margin-top:8px;display:none"></div>
          </div>

          <div id="adminPanel" style="margin-top:12px;display:none">
            <div style="display:flex;align-items:center;gap:8px;justify-content:space-between">
              <h3>Pesan Pending</h3>
              <div>
                <span id="adminInfo" class="small"></span>
                <button id="btnLogout" class="btn ghost" style="margin-left:8px">Logout</button>
              </div>
            </div>
            <div class="pending-list" id="pendingList"></div>
          </div>
        </div>
      </section>
    </main>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-app.js";
    import { getDatabase, ref, push, set, onValue, update, remove, get } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-database.js";
    import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-auth.js";

    // ======= GANTI CONFIG DENGAN PROJECTMU =======
    const firebaseConfig = {
      apiKey: "AIzaSyAh1IGfxM1RRo-c2fUbkGE0NzsZL7Mz1u4",
      authDomain: "forum-tanya-jawab.firebaseapp.com",
      databaseURL: "https://forum-tanya-jawab-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "forum-tanya-jawab",
      storageBucket: "forum-tanya-jawab.appspot.com",
      messagingSenderId: "679242793604",
      appId: "1:679242793604:web:54ae1f7608a26fdde738d1"
    };
    // ==============================================

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const auth = getAuth(app);

    // Elements
    const namaEl = document.getElementById('nama');
    const pesanEl = document.getElementById('pesan');
    const btnKirim = document.getElementById('btnKirim');
    const btnClear = document.getElementById('btnClear');
    const listPesan = document.getElementById('listPesan');
    const notice = document.getElementById('notice');

    const adminPage = document.getElementById('adminPage');
    const publicPage = document.getElementById('publicPage');
    const adminPass = document.getElementById('adminPass');
    const adminEmail = document.getElementById('adminEmail');
    const btnLogin = document.getElementById('btnLogin');
    const loginMsg = document.getElementById('loginMsg');
    const adminPanel = document.getElementById('adminPanel');
    const pendingList = document.getElementById('pendingList');
    const backPublic = document.getElementById('backPublic');
    const adminInfo = document.getElementById('adminInfo');
    const btnLogout = document.getElementById('btnLogout');

    let currentUser = null;
    let isAdmin = false;

    // PUBLIC: kirim pesan (status pending)
    btnKirim.addEventListener('click', async () => {
      const nama = (namaEl.value || 'Anonim').trim();
      const pesan = (pesanEl.value || '').trim();
      if(!pesan){ alert('Isi pesan dulu'); return }

      try {
        const messagesRef = ref(db, 'forum');
        const newRef = push(messagesRef);
        await set(newRef, { nama, pesan, status: 'pending', time: Date.now() });

        pesanEl.value = '';
        notice.innerText = 'Pesan terkirim dan menunggu verifikasi admin.';
      } catch(err){
        console.error(err);
        alert('Gagal mengirim pesan â€” coba lagi.');
      }
    });

    btnClear.addEventListener('click', ()=>{ namaEl.value=''; pesanEl.value=''; notice.innerText=''; });

    // Listen data forum
    const forumRef = ref(db, 'forum');
    onValue(forumRef, (snap) => {
      const data = snap.val() || {};
      renderApprovedList(data);
      renderPendingList(data);
    });

    function renderApprovedList(data){
      const keys = Object.keys(data || {});
      let html = '';
      for(const k of keys){
        const item = data[k];
        if(item && item.status === 'approved'){
          const t = new Date(item.time || Date.now());
          html += `\n  <div class="msg" id="msg-${k}">\n    <div class="bubble">\n      <div class="name">${escapeHtml(item.nama)}</div>\n      <div class="text">${escapeHtml(item.pesan)}</div>\n      <div class="meta">${t.toLocaleString()}</div>\n    </div>\n    <div style="margin-top:8px">\n      <button class="btn ghost" style="font-size:12px" onclick="downloadBubble('msg-${k}')">ðŸ“¥ Download</button>\n    </div>\n  </div>`;
        }
      }
      listPesan.innerHTML = html || '<div style="color:var(--muted)">Belum ada pertanyaan yang disetujui.</div>';
    }

    function renderPendingList(data){
      const keys = Object.keys(data || {});
      let html = '';
      for(const id of keys){
        const p = data[id];
        if(p && p.status === 'pending'){
          html += `<div class="pending-item"><div style="font-weight:700">${escapeHtml(p.nama)}</div><div style="margin-top:6px">${escapeHtml(p.pesan)}</div>`;
          if(isAdmin){
            html += `<div class="pending-actions"><button onclick="approve('${id}')" class="btn">Approve</button> <button onclick="del('${id}')" class="btn ghost">Hapus</button></div>`;
          } else {
            html += `<div class="small" style="margin-top:8px;color:var(--muted)">Tunggu admin untuk verifikasi.</div>`;
          }
          html += `</div>`;
        }
      }
      pendingList.innerHTML = html || '<div style="color:var(--muted)">Tidak ada pesan pending</div>';
    }

    // routing (hash) antara public / admin
    function route(){
      if(location.hash === '#admin'){
        publicPage.style.display = 'none';
        adminPage.style.display = 'block';
        adminPage.setAttribute('aria-hidden','false');

        if(currentUser && isAdmin){
          document.getElementById('loginBox').style.display = 'none';
          adminPanel.style.display = 'block';
        } else {
          adminPanel.style.display = 'none';
          document.getElementById('loginBox').style.display = 'block';
        }
      } else {
        publicPage.style.display = 'block';
        adminPage.style.display = 'none';
        adminPage.setAttribute('aria-hidden','true');
        loginMsg.style.display = 'none';
      }
    }
    window.addEventListener('hashchange', route);
    route();

    // LOGIN
    btnLogin.addEventListener('click', async () => {
      const email = (adminEmail.value || '').trim();
      const password = (adminPass.value || '').trim();

      loginMsg.style.display = "none";

      if(!email || !password){
        loginMsg.innerText = 'Masukkan email dan password.';
        loginMsg.style.color = 'red';
        loginMsg.style.display = 'block';
        return;
      }

      try {
        await signInWithEmailAndPassword(auth, email, password);
        loginMsg.innerHTML = "Login berhasil!";
        loginMsg.style.color = "green";
      } catch (error) {
        console.error(error);
        loginMsg.innerHTML = `âŒ Error: ${error.message}`;
        loginMsg.style.color = "red";
        loginMsg.style.display = "block";
      }
    });

    btnLogout.addEventListener('click', async () => {
      try {
        await signOut(auth);
      } catch(err){ console.error(err); alert('Gagal logout'); }
    });

    // auth state handler â€” cek role admin via node /admins/<uid>
    onAuthStateChanged(auth, async (user) => {
      currentUser = user;
      isAdmin = false;

      if(user && user.uid){
        try {
          const snap = await get(ref(db, `admins/${user.uid}`));
          if(snap && snap.exists && snap.val() === true){
            isAdmin = true;
          }
        } catch(e){ console.error('cek admin error', e); }
      }

      if(isAdmin){
        adminInfo.innerText = `Signed in: ${user.email}`;
        document.getElementById('loginBox').style.display = 'none';
        adminPanel.style.display = 'block';
      } else {
        adminInfo.innerText = '';
        adminPanel.style.display = 'none';
        document.getElementById('loginBox').style.display = 'block';
      }

      route();
    });

    // approve / delete functions (exposed globally so buttons can call)
    window.approve = async function(id){
      if(!currentUser || !isAdmin){ alert('Anda tidak berwenang'); return; }
      try { await update(ref(db, 'forum/' + id), { status: 'approved' }); }
      catch(err){ console.error(err); alert('Gagal approve'); }
    }

    window.del = async function(id){
      if(!currentUser || !isAdmin){ alert('Anda tidak berwenang'); return; }
      if(!confirm('Hapus pesan ini?')) return;
      try { await remove(ref(db, 'forum/' + id)); }
      catch(err){ console.error(err); alert('Gagal hapus'); }
    }

    // util
    function escapeHtml(str){ return String(str||'').replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;').replaceAll('"','&quot;').replaceAll("'","&#39;"); }
  </script>

  <!-- html2canvas for bubble download -->
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script>
    window.downloadBubble = function(id){
      const el = document.getElementById(id);
      if(!el){ alert('Elemen tidak ditemukan'); return; }

      // Clone element to ensure consistent styling and remove interactive buttons
      const clone = el.cloneNode(true);
      // remove download button if present inside clone
      const btns = clone.querySelectorAll('button');
      btns.forEach(b=>b.remove());

      // create wrapper to set background clean
      const wrapper = document.createElement('div');
      wrapper.style.padding = '18px';
      wrapper.style.background = '#ffffff';
      wrapper.style.display = 'inline-block';
      wrapper.appendChild(clone);

      document.body.appendChild(wrapper);

      html2canvas(wrapper, { backgroundColor: null, scale: 2 }).then(canvas => {
        const a = document.createElement('a');
        a.download = 'pertanyaan-' + Date.now() + '.png';
        a.href = canvas.toDataURL('image/png');
        a.click();
        wrapper.remove();
      }).catch(err => {
        console.error(err);
        wrapper.remove();
        alert('Gagal generate gambar');
      });
    };
  </script>
</body>
</html>
